---
import Layout from '../../layouts/Layout.astro'
import Subheading from '../../components/Subheading.astro'
import Input from '../../components/Input.astro'
import Button from '../../components/Button.astro'
import { Eraser } from 'lucide-astro'
---

<Layout
  title="check splitter"
  description="Calculate how to split your checks!"
>
  <p class="mb-4">
    A tool to calculate how much individuals pay (including tax & tip!) when
    splitting a check!
  </p>

  <form id="formA">
    <label class="mb-3 block">
      Individual Subtotal ($) - accepts math expressions
      <Input type="text" name="indSubtotal" placeholder="ex: 1.00 + 1.50*3" />
      <span id="exprErrorMsg" class="mt-1 text-red-500"></span>
    </label>

    <label class="my-3 block">
      Check Subtotal ($)
      <Input
        type="number"
        name="checkSubtotal"
        placeholder="0.00"
        step=".01"
        min="0"
      />
    </label>

    <label class="my-3 block">
      Check Tax + Tip ($)
      <Input type="number" name="tax" placeholder="0.00" step=".01" min="0" />
    </label>

    <Button
      id="clearBtn"
      class="mt-3 bg-purple-600 font-bold hover:bg-purple-700"
      type="button"
    >
      <Eraser class="me-1 inline w-5 align-top" />
       Clear inputs
    </Button>

    <Subheading class="mt-5">Result</Subheading>
     Individual's Total Share: $<span id="totalShare">0.00</span>
  </form>

  <hr class="my-4" />

  <!-- Upcoming features -->
  <h2 class="text-xl font-semibold text-emerald-300">Upcoming features</h2>
  <ul class="list-inside list-disc">
    <li>
      Functionality to store your results to keep track of all of a check's
      splits
    </li>
  </ul>
</Layout>

<script>
  import * as math from 'mathjs'

  const form = document.querySelector<HTMLFormElement>('#formA')
  const inputs = Array.from(form!.getElementsByTagName('input'))

  function parseInput(input: string) {
    if (!math.hasNumericValue(input)) {
      return false
    }

    return math.round(math.number(input), 2)
  }

  function calcIndShare() {
    if (!form) return

    let subtotal = parseInput(form.elements['checkSubtotal'].value) || 1
    let tax = parseInput(form.elements['tax'].value) || 0

    // Calculate individual subtotal
    const exprErrorMessage = document.getElementById('exprErrorMsg')
    let indSubtotal: number
    try {
      const indSubtotalExpr = form.elements['indSubtotal'].value
      indSubtotal = math.evaluate(indSubtotalExpr) || 0
      exprErrorMessage!.innerHTML = ''
    } catch (error) {
      exprErrorMessage!.innerHTML = '❗ Invalid arithmetic expression!'
      return
    }

    // Calculate subshares
    const taxShare = (indSubtotal / subtotal) * tax
    let totalShare = taxShare + indSubtotal

    // Update individual share
    document.getElementById('totalShare')!.innerHTML = totalShare.toFixed(2)
  }

  // Activate form calculation functionality
  form!.addEventListener('input', calcIndShare)

  // Activate clear button
  document.getElementById('clearBtn')!.addEventListener('click', () => {
    inputs.forEach((input) => {
      input.value = ''
    })
  })
</script>
